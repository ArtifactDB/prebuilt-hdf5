name: Build libraries

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build_linux_wheels:
    name: Build Linux wheels
    #if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.image }}
    strategy:
      matrix:
        include:
          - image: quay.io/pypa/manylinux2014_x86_64
            arch: "x86_64"
#          - image: quay.io/pypa/manylinux2014_aarch64
#            arch: "arm64"

    steps:
      - name: Set up CMake
        uses: lukka/get-cmake@latest

      - name: Install wget
        run: yum install -y wget

      - name: Set up ZLIB
        run: |
          wget http://zlib.net/fossils/zlib-1.3.tar.gz -O zlib.tar.gz
          tar -xvf zlib.tar.gz
          cd zlib-1.3
          cmake -S . -B build
          cmake --build build

      - name: Set up SZIP
        run: |
          git clone https://gitlab.dkrz.de/k202009/libaec
          cd libaec
          cmake -S . -B build
          cmake --build build

      - name: Set up HDF5
        run: | 
          wget https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-1_12_2.tar.gz -O bundle.tar.gz
          tar -xf bundle.tar.gz
          cwd=$(pwd)
          cd hdf5-hdf5-1_12_2/
          cmake -S . -B build \
            -DBUILD_SHARED_LIBS=OFF \
            -DHDF5_BUILD_EXAMPLES=OFF \
            -DHDF5_BUILD_TOOLS=OFF \
            -DHDF5_BUILD_UTILS=OFF \
            -DHDF5_BUILD_CPP_LIB=ON \
            -DHDF5_ENABLE_Z_LIB_SUPPORT=ON \
            -DHDF5_ENABLE_SZIP_SUPPORT=ON \
            -DBUILD_TESTING=OFF \
            -DZLIB_INCLUDE_DIR=${cwd}/zlib-1.3 \
            -DZLIB_LIBRARY=${cwd}/zlib-1.3/build/src/libz.a \
            -DSZIP_INCLUDE_DIR=${cwd}/libaec/build/include \
            -DSZIP_LIBRARY=${cwd}/libaec/build/src/libsz.a
          cmake --build build
          cpack -G TGZ --config build/CPackConfig.cmake

      - name: Upload tarballs
        uses: actions/upload-artifact@v3
        with:
          path: build/HDF5-*.tar.gz
